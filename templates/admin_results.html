@app.route('/admin/results')
@admin_required
def admin_results():
    try:
        with sqlite3.connect(DB_FILE) as conn:
            conn.row_factory = sqlite3.Row
            
            # Get all unique assessment sessions (by email and timestamp)
            assessment_sessions = conn.execute('''
                SELECT DISTINCT email, timestamp, MIN(id) as min_id
                FROM assessment_results 
                WHERE timestamp IS NOT NULL 
                GROUP BY email, timestamp 
                ORDER BY timestamp DESC
            ''').fetchall()
            
            assessments = []
            
            for session in assessment_sessions:
                email = session['email']
                timestamp = session['timestamp']
                
                # Get name from session data (if available) or use email
                name = email.split('@')[0]  # Simple fallback
                
                # Get all assessment responses for this session
                question_responses = conn.execute('''
                    SELECT question, style, answer 
                    FROM assessment_results 
                    WHERE email = ? AND timestamp = ?
                    ORDER BY id
                ''', (email, timestamp)).fetchall()
                
                # Get survey responses for this session
                survey_responses = conn.execute('''
                    SELECT question, answer 
                    FROM survey_results 
                    WHERE email = ?
                    ORDER BY id
                ''', (email,)).fetchall()
                
                # Calculate style summary
                style_scores = {
                    'Transformational': 0, 'Democratic': 0, 'Charismatic': 0, 'Autocratic': 0,
                    'Laissez-Faire': 0, 'Situational': 0, 'Transactional': 0, 'Servant': 0
                }
                
                value_map = {'1': -2, '2': -1, '3': 0, '4': 1, '5': 2}
                
                # Process responses and calculate scores
                processed_responses = []
                for response in question_responses:
                    style = response['style'] if response['style'] else 'Unknown'
                    answer = response['answer']
                    mapped_score = value_map.get(str(answer), 0)
                    
                    if style in style_scores:
                        style_scores[style] += mapped_score
                    
                    processed_responses.append({
                        'question': response['question'],
                        'style': style,
                        'answer': answer,
                        'mapped_score': mapped_score
                    })
                
                # Create style summary with tendencies
                style_summary = []
                for style, score in style_scores.items():
                    if 5 <= score <= 10:
                        tendency = 'High'
                    elif 0 <= score <= 4:
                        tendency = 'Moderate'
                    else:
                        tendency = 'Low'
                    
                    style_summary.append({
                        'style': style,
                        'score': score,
                        'tendency': tendency
                    })
                
                # Format timestamp for display
                try:
                    from datetime import datetime
                    dt = datetime.fromisoformat(timestamp.replace(' ', 'T'))
                    formatted_timestamp = dt.strftime('%m-%d-%Y %I:%M%p')
                except:
                    formatted_timestamp = timestamp
                
                assessments.append({
                    'name': name,
                    'email': email,
                    'timestamp': formatted_timestamp,
                    'question_responses': processed_responses,
                    'survey_responses': [{'question': s['question'], 'answer': s['answer']} for s in survey_responses],
                    'style_summary': style_summary
                })
            
            # Calculate stats
            total_assessments = len(assessments)
            total_surveys = len([a for a in assessments if a['survey_responses']])
            unique_users = len(set(a['email'] for a in assessments))
            
            return render_template('admin_results.html', 
                                 assessments=assessments,
                                 total_assessments=total_assessments,
                                 total_surveys=total_surveys,
                                 unique_users=unique_users)
                                 
    except Exception as e:
        return f"Admin results error: {str(e)}", 500